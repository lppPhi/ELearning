<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Khóa Học</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .course-detail-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--dark-color) 100%);
            color: var(--white-color);
            text-align: center;
            padding: 60px 20px; /* Tăng padding */
            text-align: left; /* Căn trái nội dung */
            border-bottom: 5px solid var(--accent-color);
        }
        .course-detail-header .container { /* Giới hạn chiều rộng nội dung header */
            max-width: 1000px;
            align-items: center; /* Căn giữa ngang */
            text-align: center;
            margin: 0 auto;
        }
        .course-detail-header h1 {
            font-size: 2.5em; /* Giảm một chút */
            margin-bottom: 8px;
            justify-content: center;
            font-weight: 700;
            line-height: 1.3;
        }
        .course-detail-header .course-short-description-header { /* Thêm mô tả ngắn ở đây */
            font-size: 1.1em;
            margin-bottom: 20px;
            color: var(--light-color);
            max-width: 700px; /* Giới hạn chiều rộng mô tả */
            opacity: 0.9;
        }
        .course-detail-header .instructor-info {
            
            display: flex; /* Sắp xếp avatar và tên giảng viên */
            align-items: center;
            justify-content: center;
            font-size: 1em; /* Giảm một chút */
            margin-bottom: 15px;
        }
        .course-detail-header .instructor-info img {
            width: 36px; /* Tăng kích thước avatar */
            height: 36px;
            border-radius: 50%;
            margin-left: 12px;
            margin-right: 12px; /* Tăng khoảng cách */
            border: 2px solid var(--white-color); /* Border trắng nổi bật */
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
         .course-detail-header .instructor-info strong {
            color: var(--white-color);
            font-weight: 600;
        }
        .course-detail-header .instructor-info span {
            color: var(--gray-color); /* Màu chữ "Được tạo bởi" */
            
            margin-right: 5px;
        }

        .course-detail-header .course-meta-icons {
            display: flex;
            flex-wrap: wrap; /* Cho phép xuống dòng trên mobile */
            justify-content: center;
            gap: 15px 25px; /* Khoảng cách giữa các item */
            margin-top: 20px;
        }
        .course-detail-header .course-meta-icons span {
            font-size: 0.9em;
            display: flex;
            align-items: center;
            color: var(--light-color);
            opacity: 0.9;
        }
        .course-detail-header .course-meta-icons i {
            margin-right: 8px; /* Tăng khoảng cách icon */
            color: var(--secondary-color); /* Màu icon nổi bật hơn */
            font-size: 1.1em; /* Tăng kích thước icon một chút */
        }

        .course-content-wrapper { display: flex; flex-wrap: wrap; gap: 30px; margin-top: 40px; }
        .course-main-content { flex: 3; min-width: 300px; }
        .course-sidebar { flex: 1; min-width: 280px; background-color: var(--white-color); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); align-self: flex-start; position: sticky; top: 100px; }
        .course-sidebar img.course-image-lg { width: 100%; height: 200px; object-fit: cover; border-radius: var(--border-radius); margin-bottom: 20px; background-color: #f0f0f0; }
        .course-sidebar .price { font-size: 2em; font-weight: 700; color: var(--primary-color); margin-bottom: 15px; }
        .course-sidebar .price.free { color: var(--success-color); }
        .course-sidebar .btn-enroll { margin-bottom: 15px; }
        .course-sidebar .sidebar-meta-item { display: flex; align-items: center; margin-bottom: 10px; font-size: 0.95em; }
        .course-sidebar .sidebar-meta-item i { margin-right: 10px; color: var(--primary-color); width: 20px; text-align: center; }
        .course-tabs { margin-bottom: 30px; border-bottom: 1px solid var(--gray-color); }
        .course-tabs button { background: none; border: none; padding: 15px 20px; cursor: pointer; font-size: 1.1em; font-weight: 600; color: var(--gray-color); position: relative; transition: color var(--transition-speed); }
        .course-tabs button.active { color: var(--primary-color); }
        .course-tabs button.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background-color: var(--primary-color); }
        .tab-content { display: none; padding: 20px 0; animation: fadeIn 0.5s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .course-description-full p { margin-bottom: 15px; line-height: 1.7; }
        .curriculum-section .chapter { background-color: var(--white-color); margin-bottom: 20px; border-radius: var(--border-radius); box-shadow: 0 2px 8px rgba(0,0,0,0.07); overflow: hidden; }
        .chapter-header { background-color: #f9f9f9; padding: 15px 20px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--light-color); }
        .chapter-header:hover { background-color: #f0f0f0; }
        .chapter-header h3 { font-size: 1.2em; font-weight: 600; margin: 0; }
        .chapter-toggle-icon { transition: transform 0.3s ease; }
        .chapter-header.open .chapter-toggle-icon { transform: rotate(180deg); }
        .chapter-parts { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; }
        .chapter-parts ul { padding: 0; margin: 0; }
        .chapter-parts li { padding: 12px 20px 12px 40px; border-bottom: 1px solid var(--light-color); display: flex; justify-content: space-between; align-items: center; transition: background-color var(--transition-speed); }
        .chapter-parts li:last-child { border-bottom: none; }
        .chapter-parts li:hover { background-color: var(--light-color); }
        .part-name { flex-grow: 1; } .part-name i { margin-right: 10px; color: var(--secondary-color); }
        .part-document-link { font-size: 0.85em; color: var(--accent-color); margin-left: 10px; text-decoration: underline !important; }
        .part-document-link i { margin-right: 3px; }
        .instructor-bio-section img { width: 100px; height: 100px; border-radius: 50%; float: left; margin-right: 20px; margin-bottom: 10px; border: 3px solid var(--secondary-color); }
        .instructor-bio-section h3 { font-size: 1.5em; margin-bottom: 10px; }
        .instructor-bio-section p { line-height: 1.7; margin-bottom: 10px; }
        .instructor-bio-section::after { content: ""; clear: both; display: table; }
        #course-detail-loader, .error-message-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 70vh; text-align: center; padding: 50px; }
        #course-detail-loader .spinner { margin: 0 auto 20px auto; }
        .error-message-container p.error-message { font-size: 1.2em; color: var(--error-color); }
        .error-message-container i { font-size: 3em; color: var(--error-color); margin-bottom: 15px; }
        @media (max-width: 992px) { .course-sidebar { position: static; margin-top: 30px; width: 100%; } }
        @media (max-width: 768px) { .course-detail-header { padding: 40px 20px; } .course-detail-header h1 { font-size: 2em; } .course-detail-header .course-short-description-header { font-size: 1em;} .course-content-wrapper { flex-direction: column; } }
        @media (max-width: 576px) { .course-detail-header .course-meta-icons { justify-content: center; gap: 10px 15px;} }
    </style>
</head>
<body>
    <div id="page-loader"><div class="spinner"></div><p>Đang tải...</p></div>
    <header><div class="container"><a href="index.html" class="logo"><i class="fas fa-graduation-cap"></i> E-Learn</a><nav><ul><li><a href="index.html">Trang Chủ</a></li><li><a href="index.html#courses-section">Khóa Học</a></li><li><a href="my-courses.html">Khóa Học Của Tôi</a></li></ul></nav><div class="auth-buttons" style="display: flex;"><button id="loginBtn" class="btn btn-secondary">Đăng Nhập</button><button id="registerBtn" class="btn btn-primary">Đăng Ký</button></div><div id="userInfo" class="user-info" style="display:none;"><img id="userAvatar" src="images/default-avatar.png" alt="Avatar" class="avatar"><span id="usernameDisplay"></span><div class="dropdown"><button class="dropdown-btn"><i class="fas fa-chevron-down"></i></button><div class="dropdown-content"><a href="profile.html" id="profileLink"><i class="fas fa-user"></i> Hồ sơ</a><a href="my-courses.html" id="myCoursesLink"><i class="fas fa-book-open-reader"></i> Khóa học của tôi</a><a href="create-course.html" id="createCourseLink"><i class="fas fa-plus-circle"></i> Tạo khóa học</a><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a></div></div></div><button class="mobile-menu-toggle"><i class="fas fa-bars"></i></button></div></header>
    <nav class="mobile-menu"><ul><li><a href="index.html">Trang Chủ</a></li><li><a href="index.html#courses-section">Khóa Học</a></li><li><a href="my-courses.html">Khóa Học Của Tôi</a></li></ul><div class="mobile-auth-buttons" style="padding: 15px;"></div></nav>

    <main id="course-detail-page">
        <div id="course-detail-loader"><div class="spinner"></div><p>Đang tải thông tin khóa học...</p></div>
        <div id="course-detail-content" style="display: none;">
            <section class="course-detail-header">
                <div class="container">
                    <h1 id="course-title-header"></h1>
                    <div class="instructor-info">Được tạo bởi <img id="instructor-avatar-header" src="images/default-avatar.png" alt="Instructor Avatar"> <strong id="instructor-name-header"></strong></div>
                    <div class="course-meta-icons">
                        <span id="total-students-header"><i class="fas fa-users"></i> </span>
                        <span id="total-chapters-header"><i class="fas fa-layer-group"></i> </span>
                        <span id="total-parts-header"><i class="fas fa-list-ul"></i> </span>
                    </div>
                </div>
            </section>
            <div class="container section-padding">
                <div class="course-content-wrapper">
                    <div class="course-main-content">
                        <div class="course-tabs">
                            <button class="tab-button active" data-tab="description">Mô Tả</button>
                            <button class="tab-button" data-tab="curriculum">Nội Dung Khóa Học</button>
                            <button class="tab-button" data-tab="instructor">Giảng Viên</button>
                        </div>
                        <div id="description" class="tab-content active course-description-full"><p id="course-long-description">Loading description...</p></div>
                        <div id="curriculum" class="tab-content curriculum-section">
                            <div style="text-align: right; margin-bottom: 15px;">
                                <a href="#" id="manage-curriculum-btn" class="btn btn-secondary" style="display: none;"><i class="fas fa-cogs"></i> Thay đổi Chương trình học</a>
                            </div>
                            <p id="curriculum-loading-text">Loading curriculum...</p>
                        </div>
                        <div id="instructor" class="tab-content instructor-bio-section">
                            <img id="instructor-avatar-bio" src="images/default-avatar.png" alt="Instructor Avatar">
                            <h3 id="instructor-name-bio"></h3>
                            <p id="instructor-email-bio"></p><p id="instructor-phone-bio"></p>
                            <p id="instructor-additional-info-bio">Thông tin thêm về giảng viên.</p>
                        </div>
                    </div>
                    <aside class="course-sidebar">
                        <img id="course-image-sidebar-display" src="images/nophoto.png" alt="Ảnh bìa khóa học" class="course-image-lg">
                        <p id="course-short-description-sidebar" style="margin-bottom: 15px; font-size: 0.9em; color: #555;"></p>
                        <div id="course-price-sidebar" class="price">Đang tải...</div>
                        <button id="enroll-button" class="btn btn-primary btn-block btn-enroll">Đăng Ký Học</button>
                        <button id="edit-course-button" class="btn btn-secondary btn-block" style="display: none; margin-top: 10px;"><i class="fas fa-edit"></i> Chỉnh Sửa Khóa Học</button>
                        <button id="delete-course-button" class="btn btn-danger btn-block" style="display: none; margin-top: 10px;"><i class="fas fa-trash-alt"></i> Xóa Khóa Học</button>
                        <div class="sidebar-meta">
                            <h4>Thông Tin Khóa Học:</h4>
                            <div class="sidebar-meta-item"><i class="fas fa-layer-group"></i> <span id="sidebar-chapters-count">0</span> chương</div>
                            <div class="sidebar-meta-item"><i class="fas fa-list-ul"></i> <span id="sidebar-parts-count">0</span> bài học</div>
                            <div class="sidebar-meta-item"><i class="fas fa-users"></i> <span id="sidebar-students-count">0</span> học viên</div>
                            <div class="sidebar-meta-item"><i class="fas fa-globe"></i> Truy cập mọi lúc</div>
                            <div class="sidebar-meta-item"><i class="fas fa-certificate"></i> Chứng chỉ (nếu có)</div>
                        </div>
                    </aside>
                </div>
            </div>
        </div>
    </main>
    <footer><div class="container"><div class="footer-content"><div class="footer-section about"><h3 class="logo-text"><i class="fas fa-graduation-cap"></i> E-Learn</h3><p>E-Learn là nền tảng học trực tuyến hàng đầu...</p></div><div class="footer-section links"><h3>Liên Kết Nhanh</h3><ul><li><a href="#">Về Chúng Tôi</a></li></ul></div><div class="footer-section contact-form-footer"><h3>Liên Hệ</h3><p><i class="fas fa-phone"></i>   123-456-7890</p><p><i class="fas fa-envelope"></i>   info@elearn.com</p></div></div><div class="footer-bottom">© <span id="currentYear"></span> E-Learn Platform | Designed by AI with Love</div></div></footer>
    <div id="loginModal" class="modal"><div class="modal-content"><span class="close-btn" id="closeLoginModal">×</span><h2>Đăng Nhập</h2><form id="loginForm"><div class="form-group"><label for="loginUsername">Tên đăng nhập:</label><input type="text" id="loginUsername" name="UserName" required></div><div class="form-group"><label for="loginPassword">Mật khẩu:</label><input type="password" id="loginPassword" name="Password" required></div><button type="submit" class="btn btn-primary btn-block">Đăng Nhập</button><p class="form-message" id="loginMessage"></p><p class="switch-form">Chưa có tài khoản? <a href="#" id="switchToRegister">Đăng ký ngay</a></p></form></div></div>
    <div id="registerModal" class="modal"><div class="modal-content"><span class="close-btn" id="closeRegisterModal">×</span><h2>Đăng Ký</h2><form id="registerForm"><div class="form-group"><label for="registerUsername">Tên đăng nhập:</label><input type="text" id="registerUsername" name="UserName" required></div><div class="form-group"><label for="registerEmail">Email:</label><input type="email" id="registerEmail" name="Email" required></div><div class="form-group"><label for="registerPassword">Mật khẩu:</label><input type="password" id="registerPassword" name="Password" required></div><div class="form-group"><label for="registerPhone">Số điện thoại (tùy chọn):</label><input type="tel" id="registerPhone" name="Phone"></div><button type="submit" class="btn btn-primary btn-block">Đăng Ký</button><p class="form-message" id="registerMessage"></p><p class="switch-form">Đã có tài khoản? <a href="#" id="switchToLogin">Đăng nhập</a></p></form></div></div>

    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const API_BASE_URL = 'http://127.0.0.1:8000';
            const STATIC_CONTENT_BASE_URL = API_BASE_URL; 

            const courseDetailLoaderEl = document.getElementById('course-detail-loader');
            const courseDetailContentEl = document.getElementById('course-detail-content');
            const courseImageSidebarDisplayEl = document.getElementById('course-image-sidebar-display');
            const courseTitleHeaderEl = document.getElementById('course-title-header');
            const instructorAvatarHeaderEl = document.getElementById('instructor-avatar-header');
            const instructorNameHeaderEl = document.getElementById('instructor-name-header');
            const totalStudentsHeaderEl = document.getElementById('total-students-header');
            const totalChaptersHeaderEl = document.getElementById('total-chapters-header');
            const totalPartsHeaderEl = document.getElementById('total-parts-header');
            const courseShortDescriptionSidebarEl = document.getElementById('course-short-description-sidebar');
            const coursePriceSidebarEl = document.getElementById('course-price-sidebar');
            const enrollButtonEl = document.getElementById('enroll-button');
            const editCourseButtonEl = document.getElementById('edit-course-button');
            const deleteCourseButtonEl = document.getElementById('delete-course-button');
            const sidebarChaptersCountEl = document.getElementById('sidebar-chapters-count');
            const sidebarPartsCountEl = document.getElementById('sidebar-parts-count');
            const sidebarStudentsCountEl = document.getElementById('sidebar-students-count');
            const courseLongDescriptionEl = document.getElementById('course-long-description');
            const curriculumTabContentEl = document.getElementById('curriculum');
            const curriculumLoadingTextEl = document.getElementById('curriculum-loading-text');
            const instructorAvatarBioEl = document.getElementById('instructor-avatar-bio');
            const instructorNameBioEl = document.getElementById('instructor-name-bio');
            const instructorEmailBioEl = document.getElementById('instructor-email-bio');
            const instructorPhoneBioEl = document.getElementById('instructor-phone-bio');
            const instructorAdditionalInfoBioEl = document.getElementById('instructor-additional-info-bio');
            const tabButtons = document.querySelectorAll('.course-tabs .tab-button');
            const tabContents = document.querySelectorAll('.course-main-content .tab-content');

            let currentCourseId = null;
            let currentCourseData = null;

            async function apiRequest(endpoint, method = 'GET', data = null, token = null) {
                const config = { method: method, headers: { 'Content-Type': 'application/json' } };
                if (token) config.headers['Authorization'] = `Bearer ${token}`;
                if (data && (method === 'POST' || method === 'PUT' || method === 'DELETE')) config.body = JSON.stringify(data);
                if (method === 'DELETE' && !data) delete config.body;
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                    if (method === 'DELETE' && (response.status === 200 || response.status === 204)) {
                        if (response.status === 204 || response.headers.get("content-length") === "0") return null;
                        const ct = response.headers.get("content-type");
                        if (ct && ct.includes("application/json")) return await response.json();
                        return { ok: true };
                    }
                    if (!response.ok) {
                        const eD = await response.json().catch(() => ({ detail: `HTTP error ${response.status}` }));
                        throw new Error(eD.detail || `HTTP error ${response.status}`);
                    }
                    if (response.status === 204 || response.headers.get("content-length") === "0") return null;
                    return await response.json();
                } catch (error) { console.error(`API request to ${endpoint} failed:`, error); throw error; }
            }

            function getCourseIdFromUrl() { return new URLSearchParams(window.location.search).get('id'); }
            function displayErrorPage(message) { courseDetailLoaderEl.innerHTML = `<div class="error-message-container"><i class="fas fa-exclamation-triangle"></i><p class="error-message">${message}</p><a href="index.html" class="btn btn-primary" style="margin-top:15px;">Về Trang Chủ</a></div>`; courseDetailContentEl.style.display = 'none'; courseDetailLoaderEl.style.display = 'flex'; }

            function setCourseImage(imageUrl) {
                let finalImageUrl = 'images/nophoto.png';
                if (imageUrl) {
                    if (imageUrl.startsWith('http://') || imageUrl.startsWith('https://')) {
                        finalImageUrl = imageUrl;
                    } else if (imageUrl.startsWith('/static/')) {
                        finalImageUrl = `${STATIC_CONTENT_BASE_URL}${imageUrl}`;
                    }
                }
                courseImageSidebarDisplayEl.src = finalImageUrl;
                courseImageSidebarDisplayEl.onerror = function() { this.onerror = null; this.src = 'images/nophoto.png'; };
            }

            async function fetchAndDisplayCourseDetail(courseId) {
                if (!courseId) { displayErrorPage('Không tìm thấy ID khóa học trên URL.'); return; }
                currentCourseId = courseId;
                courseDetailLoaderEl.style.display = 'block';
                courseDetailContentEl.style.display = 'none';

                try {
                    const course = await apiRequest(`/courses/${courseId}/detail`);
                    if (!course) { displayErrorPage(`Không tìm thấy thông tin cho khóa học ID: ${courseId}.`); return; }
                    currentCourseData = course;

                    const creator = await apiRequest(`/courses/${courseId}/creator`);
                    const chapters = await apiRequest(`/courses/${courseId}/chapters`);

                    setCourseImage(course.Image);

                    if (courseTitleHeaderEl) courseTitleHeaderEl.textContent = course.CourseName;
                    if (courseShortDescriptionSidebarEl) courseShortDescriptionSidebarEl.textContent = course.Decription || 'Chưa có mô tả ngắn.';
                    if (coursePriceSidebarEl) {
                        coursePriceSidebarEl.textContent = parseFloat(course.Price) > 0 ? `$${parseFloat(course.Price).toFixed(2)}` : 'Miễn phí';
                        if (parseFloat(course.Price) <= 0) coursePriceSidebarEl.classList.add('free'); else coursePriceSidebarEl.classList.remove('free');
                    }
                    if (totalStudentsHeaderEl) totalStudentsHeaderEl.innerHTML = `<i class="fas fa-users"></i> ${course.NumberOfRegistrations || 0} học viên`;
                    if (sidebarStudentsCountEl) sidebarStudentsCountEl.textContent = course.NumberOfRegistrations || 0;
                    
                    if (creator) {
                        if (instructorAvatarHeaderEl) instructorAvatarHeaderEl.src = creator.Image ? (creator.Image.startsWith('http') ? creator.Image : `${STATIC_CONTENT_BASE_URL}${creator.Image}`) : 'images/default-avatar.png';
                        if (instructorNameHeaderEl) instructorNameHeaderEl.textContent = creator.UserName;
                        if (instructorAvatarBioEl) instructorAvatarBioEl.src = creator.Image ? (creator.Image.startsWith('http') ? creator.Image : `${STATIC_CONTENT_BASE_URL}${creator.Image}`) : 'images/default-avatar.png';
                        if (instructorNameBioEl) instructorNameBioEl.textContent = creator.UserName;
                        if (instructorEmailBioEl) instructorEmailBioEl.innerHTML = `<i class="fas fa-envelope"></i> Email: ${creator.Email}`;
                        if (instructorPhoneBioEl) instructorPhoneBioEl.innerHTML = creator.Phone ? `<i class="fas fa-phone"></i> Điện thoại: ${creator.Phone}` : '';
                        if (instructorAdditionalInfoBioEl) instructorAdditionalInfoBioEl.textContent = `Giới thiệu về giảng viên ${creator.UserName}.`;
                    } else {
                        if (instructorAdditionalInfoBioEl) instructorAdditionalInfoBioEl.textContent = 'Không có thông tin giảng viên.';
                    }
                    if (courseLongDescriptionEl) courseLongDescriptionEl.textContent = course.DetailCourse || course.Decription || 'Không có mô tả chi tiết cho khóa học này.';
                    
                    const manageBtnContainer = curriculumTabContentEl.querySelector('div[style*="text-align: right"]');
                    if (!manageBtnContainer) { // Nếu chưa có, tạo mới
                        const newManageBtnContainer = document.createElement('div');
                        newManageBtnContainer.style.textAlign = 'right';
                        newManageBtnContainer.style.marginBottom = '15px';
                        const manageCurriculumBtnEl = document.createElement('a');
                        manageCurriculumBtnEl.id = 'manage-curriculum-btn';
                        manageCurriculumBtnEl.className = 'btn btn-secondary';
                        manageCurriculumBtnEl.style.display = 'none';
                        manageCurriculumBtnEl.innerHTML = '<i class="fas fa-cogs"></i> Thay đổi Chương trình học';
                        newManageBtnContainer.appendChild(manageCurriculumBtnEl);
                        curriculumTabContentEl.prepend(newManageBtnContainer); // Thêm vào đầu tab
                    }
                    // Xóa placeholder "Loading curriculum..." nếu nó là text node cuối cùng
                    if (curriculumLoadingTextEl && curriculumLoadingTextEl.parentNode === curriculumTabContentEl) {
                         curriculumTabContentEl.removeChild(curriculumLoadingTextEl);
                    }


                    let totalPartsCount = 0;
                    if (chapters && chapters.length > 0) {
                        if (sidebarChaptersCountEl) sidebarChaptersCountEl.textContent = chapters.length;
                        if (totalChaptersHeaderEl) totalChaptersHeaderEl.innerHTML = `<i class="fas fa-layer-group"></i> ${chapters.length} chương`;
                        // Xóa các chapter cũ trước khi render lại (nếu có)
                        Array.from(curriculumTabContentEl.getElementsByClassName('chapter')).forEach(el => el.remove());

                        for (const chapter of chapters) {
                            const chapterElement = await createChapterElement(chapter);
                            curriculumTabContentEl.appendChild(chapterElement);
                            const parts = chapter.parts || await apiRequest(`/chapters/${chapter.ChapterID}/parts`);
                            totalPartsCount += (parts ? parts.length : 0);
                        }
                    } else {
                        if (sidebarChaptersCountEl) sidebarChaptersCountEl.textContent = 0;
                        if (totalChaptersHeaderEl) totalChaptersHeaderEl.innerHTML = `<i class="fas fa-layer-group"></i> 0 chương`;
                         Array.from(curriculumTabContentEl.getElementsByClassName('chapter')).forEach(el => el.remove()); // Xóa chapter cũ
                        if (!curriculumTabContentEl.querySelector('.no-curriculum-message')) { // Tránh thêm nhiều lần
                            const noContentPara = document.createElement('p');
                            noContentPara.className = 'no-curriculum-message';
                            noContentPara.textContent = 'Khóa học này chưa có nội dung chương mục.';
                            curriculumTabContentEl.appendChild(noContentPara);
                        }
                    }
                    if (sidebarPartsCountEl) sidebarPartsCountEl.textContent = totalPartsCount;
                    if (totalPartsHeaderEl) totalPartsHeaderEl.innerHTML = `<i class="fas fa-list-ul"></i> ${totalPartsCount} bài học`;

                    const loggedInUserData = JSON.parse(localStorage.getItem('userData'));
                    const manageCurriculumBtnFromDOM = document.getElementById('manage-curriculum-btn');
                    if (loggedInUserData && creator && loggedInUserData.UserID === creator.UserID) {
                        if (editCourseButtonEl) { editCourseButtonEl.style.display = 'block'; editCourseButtonEl.onclick = () => { window.location.href = `edit-course.html?id=${course.CourseID}`; }; }
                        if (deleteCourseButtonEl) { deleteCourseButtonEl.style.display = 'block'; deleteCourseButtonEl.onclick = () => handleDeleteCourse(course.CourseID, course.CourseName); }
                        if (manageCurriculumBtnFromDOM) { manageCurriculumBtnFromDOM.style.display = 'inline-block'; manageCurriculumBtnFromDOM.href = `manage-curriculum.html?courseId=${course.CourseID}`; }
                    } else {
                        if (editCourseButtonEl) editCourseButtonEl.style.display = 'none';
                        if (deleteCourseButtonEl) deleteCourseButtonEl.style.display = 'none';
                        if (manageCurriculumBtnFromDOM) manageCurriculumBtnFromDOM.style.display = 'none';
                    }

                    courseDetailLoaderEl.style.display = 'none';
                    courseDetailContentEl.style.display = 'block';
                    checkAndUpdateEnrollmentStatus(); 
                } catch (error) { console.error('Lỗi tải chi tiết khóa học:', error); displayErrorPage(`Lỗi tải chi tiết khóa học: ${error.message}`); }
            }

            async function createChapterElement(chapter) {
                const chapterDiv = document.createElement('div'); chapterDiv.className = 'chapter';
                const header = document.createElement('div'); header.className = 'chapter-header';
                header.innerHTML = `<h3>${chapter.ChapterName}</h3><i class="fas fa-chevron-down chapter-toggle-icon"></i>`;
                const partsListContainer = document.createElement('div'); partsListContainer.className = 'chapter-parts';
                const partsUl = document.createElement('ul'); partsListContainer.appendChild(partsUl);
                chapterDiv.appendChild(header); chapterDiv.appendChild(partsListContainer);
                const parts = chapter.parts || await apiRequest(`/chapters/${chapter.ChapterID}/parts`);
                if (parts && parts.length > 0) {
                    parts.forEach(part => {
                        const partLi = document.createElement('li'); let docHTML = '';
                        if (part.Document) {
                            const isVideo = /\.(mp4|webm|ogg|mov)$/i.test(part.Document) || /youtu\.be|youtube\.com/i.test(part.Document);
                            const icon = isVideo ? 'fa-video' : 'fa-file-alt';
                            const linkUrl = (part.Document.startsWith('http') ? part.Document : `${API_BASE_URL}${part.Document}`);
                            docHTML = `<a href="${linkUrl}" target="_blank" class="part-document-link"><i class="fas ${icon}"></i> ${isVideo ? 'Xem' : 'Tài liệu'}</a>`;
                        }
                        partLi.innerHTML = `<span class="part-name"><i class="fas fa-play-circle"></i> ${part.PartName}</span>${docHTML}`;
                        partsUl.appendChild(partLi);
                    });
                } else { partsUl.innerHTML = '<li>Chương này chưa có phần học.</li>'; }
                header.addEventListener('click', () => { const isOpen = partsListContainer.classList.toggle('open'); header.classList.toggle('open', isOpen); partsListContainer.style.maxHeight = isOpen ? partsListContainer.scrollHeight + "px" : "0"; });
                return chapterDiv;
            }
            
            tabButtons.forEach(button => { button.addEventListener('click', () => { tabButtons.forEach(btn => btn.classList.remove('active')); button.classList.add('active'); tabContents.forEach(content => content.classList.remove('active')); const activeTab = document.getElementById(button.dataset.tab); if (activeTab) activeTab.classList.add('active'); }); });
            if (enrollButtonEl) { enrollButtonEl.addEventListener('click', async () => { /* ... */ });}
            async function checkAndUpdateEnrollmentStatus() { /* ... */ }
            async function handleDeleteCourse(courseId, courseName) { /* ... */ }

            const courseIdToLoad = getCourseIdFromUrl();
            if (courseIdToLoad) { fetchAndDisplayCourseDetail(courseIdToLoad); }
            else { displayErrorPage('Không tìm thấy ID khóa học trong URL.'); }
            window.addEventListener('load', () => { const pl=document.getElementById('page-loader'); if(pl){pl.style.opacity='0';setTimeout(()=>pl.style.display='none',500);}});
            const cye=document.getElementById('currentYear'); if(cye)cye.textContent=new Date().getFullYear();
        });
    </script>
</body>
</html>